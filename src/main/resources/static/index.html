<!DOCTYPE html>
<html>
<head>
  <title>Office Document Processor</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
    .page { width: clamp(320px, 90vw, 880px); margin-inline: auto; }

    .method { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    label { font-weight: 600; display: block; margin: 8px 0 4px; }
    input[type="file"] { margin: 10px 0; }
    select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
    textarea { resize: vertical; min-height: 96px; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0056b3; }
    small.hint { color: #666; display: block; margin-top: 4px; }

    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .row { grid-template-columns: 1fr 1fr; } }

    .hidden { display: none; }
    .inline { display: inline-flex; align-items: center; gap: 8px; }

    /* ç­‰å¾…æç¤ºæ¡† */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(1px); }
    .overlay.hidden { display: none; }
    .modal { width: min(90vw, 420px); background: #fff; border-radius: 12px; padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
    .spinner { width: 48px; height: 48px; border-radius: 50%; border: 4px solid #e3e3e3; border-top-color: #007bff;
      margin: 0 auto 12px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dim { color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="page">
    <h1>ğŸ“„ Office Document Processor</h1>

    <div class="method">
      <h2>ğŸ“ æ–‡æ¡£ç¿»è¯‘</h2>
      <p>æ”¯æŒ .doc, .docx, .xls, .xlsx, .ppt, .pptx â€” è½»é‡çº§è§£å†³æ–¹æ¡ˆ</p>

      <!-- å»æ‰ targetï¼ˆä¸å†ç”¨ iframeï¼‰ -->
      <form id="form" action="/api/process" method="post" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label for="sourceLang">åŸæ–‡è¯­è¨€</label>
            <select id="sourceLang" name="sourceLang" aria-describedby="srcHint">
              <option value="auto" selected>è‡ªåŠ¨è¯†åˆ«</option>
              <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
              <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
              <option value="en">Englishï¼ˆè‹±æ–‡ï¼‰</option>
              <option value="ja">æ—¥æœ¬èªï¼ˆæ—¥æ–‡ï¼‰</option>
              <option value="ko">í•œêµ­ì–´ï¼ˆéŸ©æ–‡ï¼‰</option>
              <option value="de">Deutschï¼ˆå¾·æ–‡ï¼‰</option>
              <option value="fr">FranÃ§aisï¼ˆæ³•æ–‡ï¼‰</option>
              <option value="es">EspaÃ±olï¼ˆè¥¿ç­ç‰™æ–‡ï¼‰</option>
              <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ï¼ˆä¿„æ–‡ï¼‰</option>
              <option value="pt">PortuguÃªsï¼ˆè‘¡è„ç‰™æ–‡ï¼‰</option>
              <option value="it">Italianoï¼ˆæ„å¤§åˆ©æ–‡ï¼‰</option>
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ï¼ˆé˜¿æ‹‰ä¼¯æ–‡ï¼‰</option>
              <option value="vi">Tiáº¿ng Viá»‡tï¼ˆè¶Šå—æ–‡ï¼‰</option>
              <option value="th">à¹„à¸—à¸¢ï¼ˆæ³°æ–‡ï¼‰</option>
              <option value="id">Bahasa Indonesiaï¼ˆå°å°¼æ–‡ï¼‰</option>
              <option value="tr">TÃ¼rkÃ§eï¼ˆåœŸè€³å…¶æ–‡ï¼‰</option>
              <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€ï¼ˆå°åœ°æ–‡ï¼‰</option>
            </select>
          </div>

          <div>
            <label for="targetLang">ç›®æ ‡è¯­è¨€</label>
            <select id="targetLang" name="targetLang" required aria-describedby="tgtHint">
              <option value="en" selected>Englishï¼ˆè‹±æ–‡ï¼‰</option>
              <option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
              <option value="zh-TW">ä¸­æ–‡ï¼ˆç¹é«”ï¼‰</option>
              <option value="ja">æ—¥æœ¬èªï¼ˆæ—¥æ–‡ï¼‰</option>
              <option value="ko">í•œêµ­ì–´ï¼ˆéŸ©æ–‡ï¼‰</option>
              <option value="de">Deutschï¼ˆå¾·æ–‡ï¼‰</option>
              <option value="fr">FranÃ§aisï¼ˆæ³•æ–‡ï¼‰</option>
              <option value="es">EspaÃ±olï¼ˆè¥¿ç­ç‰™æ–‡ï¼‰</option>
              <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ï¼ˆä¿„æ–‡ï¼‰</option>
              <option value="pt">PortuguÃªsï¼ˆè‘¡è„ç‰™æ–‡ï¼‰</option>
              <option value="it">Italianoï¼ˆæ„å¤§åˆ©æ–‡ï¼‰</option>
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ï¼ˆé˜¿æ‹‰ä¼¯æ–‡ï¼‰</option>
              <option value="vi">Tiáº¿ng Viá»‡tï¼ˆè¶Šå—æ–‡ï¼‰</option>
              <option value="th">à¹„à¸—à¸¢ï¼ˆæ³°æ–‡ï¼‰</option>
              <option value="id">Bahasa Indonesiaï¼ˆå°å°¼æ–‡ï¼‰</option>
              <option value="tr">TÃ¼rkÃ§eï¼ˆåœŸè€³å…¶æ–‡ï¼‰</option>
              <option value="hi">à¦¹à¤¿à¤¨à¥à¤¦à¥€ï¼ˆå°åœ°æ–‡ï¼‰</option>
            </select>
          </div>
        </div>

        <label class="inline" for="usePrompt">
          <input type="checkbox" id="usePrompt" />
          ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯
        </label>

        <div id="promptWrap" class="hidden">
          <label for="userPrompt">è‡ªå®šä¹‰æç¤ºè¯</label>
          <textarea id="userPrompt" name="userPrompt"
            placeholder="ä¾‹ï¼šè¿™ç¯‡æ–‡ç« ä¸æ³•åŠ¡æ¡æ¬¾ç›¸å…³ï¼Œç¿»è¯‘æ—¶è¯·å°½é‡ä½¿ç”¨ä¸“ä¸šæ³•å¾‹æœ¯è¯­ï¼›è¾“å‡ºæ’ç‰ˆä¸åŸæ–‡ä¿æŒä¸€è‡´ã€‚"
            disabled></textarea>
        </div>

        <label for="file">é€‰æ‹©æ–‡ä»¶</label>
        <input id="file" type="file" name="file" accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx" required>

        <button id="submitBtn" type="submit">ä½¿ç”¨ POI å¤„ç†</button>
      </form>
    </div>
  </div>

  <!-- ç­‰å¾…æç¤ºæ¡† -->
  <div id="overlay" class="overlay hidden" role="alertdialog" aria-live="assertive" aria-busy="true" aria-modal="true">
    <div class="modal">
      <div class="spinner" aria-hidden="true"></div>
      <div id="progressTitle" style="font-weight:700; margin-bottom: 6px;">æ­£åœ¨ç¿»è¯‘ä¸å¤„ç†æ–‡ä»¶â€¦</div>
      <div id="progressTip" class="dim">æ ¹æ®æ–‡ä»¶å¤§å°ï¼Œè¿™éœ€è¦ä¸€ä¼šå„¿ã€‚å¤„ç†ä¸­<span id="dots">...</span></div>
    </div>
  </div>

  <script>
    // è¯­è¨€é€‰æ‹©æŒä¹…åŒ–
    const srcSel = document.getElementById('sourceLang');
    const tgtSel = document.getElementById('targetLang');
    srcSel.value = localStorage.getItem('sourceLang') || srcSel.value;
    tgtSel.value = localStorage.getItem('targetLang') || tgtSel.value;
    srcSel.addEventListener('change', () => localStorage.setItem('sourceLang', srcSel.value));
    tgtSel.addEventListener('change', () => localStorage.setItem('targetLang', tgtSel.value));

    // è‡ªå®šä¹‰æç¤ºè¯å¼€å…³
    const usePrompt = document.getElementById('usePrompt');
    const promptWrap = document.getElementById('promptWrap');
    const userPrompt = document.getElementById('userPrompt');
    function syncPromptUI() {
      const on = usePrompt.checked;
      promptWrap.classList.toggle('hidden', !on);
      userPrompt.disabled = !on;
      if (!on) userPrompt.value = '';
      localStorage.setItem('usePrompt', String(on));
    }
    usePrompt.checked = localStorage.getItem('usePrompt') === 'true';
    syncPromptUI();
    usePrompt.addEventListener('change', syncPromptUI);

    // ç­‰å¾…æç¤ºæ¡†
    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');
    const overlay = document.getElementById('overlay');
    const dots = document.getElementById('dots');

    let dotsTimer;
    function showOverlay() {
      overlay.classList.remove('hidden');
      if (submitBtn) submitBtn.disabled = true;
      let i = 0;
      dots.textContent = '';
      dotsTimer = setInterval(() => { i = (i + 1) % 4; dots.textContent = '.'.repeat(i); }, 350);
    }
    function hideOverlay() {
      overlay.classList.add('hidden');
      if (submitBtn) submitBtn.disabled = false;
      clearInterval(dotsTimer);
    }

    // ç»Ÿä¸€çš„æäº¤å¤„ç†ï¼šfetch + Blob ä¸‹è½½
    form.addEventListener('submit', async (e) => {
      // åŸç”Ÿæ ¡éªŒ
      if (!form.checkValidity()) return;
      // è‡ªå®šä¹‰æç¤ºè¯ä¸ºç©ºçš„äºŒæ¬¡æ ¡éªŒ
      if (usePrompt.checked && userPrompt.value.trim().length === 0) {
        e.preventDefault();
        alert('å·²å‹¾é€‰â€œä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯â€ï¼Œä½†å†…å®¹ä¸ºç©ºï¼Œè¯·å¡«å†™æˆ–å–æ¶ˆå‹¾é€‰ã€‚');
        return;
      }

      e.preventDefault(); // æ‹¦æˆªé»˜è®¤è¡¨å•æäº¤
      showOverlay();

      try {
        const fd = new FormData(form);
        const resp = await fetch(form.action, { method: 'POST', body: fd });

        // å¤±è´¥å“åº”ï¼ˆå°½é‡ç»™å‡ºå¯è¯»ä¿¡æ¯ï¼‰
        if (!resp.ok) {
          const ct = resp.headers.get('content-type') || '';
          const msg = ct.includes('application/json') ? JSON.stringify(await resp.json()) : await resp.text();
          throw new Error(`HTTP ${resp.status} ${resp.statusText} - ${msg?.slice?.(0, 200) || ''}`);
        }

        // è§£ææ–‡ä»¶å
        const disposition = resp.headers.get('content-disposition') || '';
        let filename = 'translated';
        const m1 = /filename\*=UTF-8''([^;]+)/i.exec(disposition);
        const m2 = /filename="?([^";]+)"?/i.exec(disposition);
        if (m1) filename = decodeURIComponent(m1[1]);
        else if (m2) filename = m2[1];

        // ä¸‹è½½
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename || 'download';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('ä¸‹è½½å¤±è´¥ï¼š' + (err?.message || err));
      } finally {
        hideOverlay();
      }
    });

    // å…œåº•ï¼šä»»ä½•æœªæ•è·é”™è¯¯ä¹Ÿå…³é—­é®ç½©ï¼Œé¿å…â€œå¡ä½â€
    window.addEventListener('error', () => hideOverlay(), true);
    window.addEventListener('unhandledrejection', () => hideOverlay());
  </script>
</body>
</html>
